// ignore_for_file: use_build_context_synchronously

import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:provider/provider.dart';
import 'package:crowwn/api/advice_api.dart';
import 'package:crowwn/widgets/topup_helper.dart';
import 'package:crowwn/services/advice_unlocked_store.dart';
import 'package:crowwn/services/advice_seen_store.dart';
import 'advice_view.dart';
import '../Dark mode.dart';

class AdviceListPage extends StatefulWidget {
  final String category; // stocks, options, future, commodity
  const AdviceListPage({super.key, required this.category});

  @override
  State<AdviceListPage> createState() => _AdviceListPageState();
}

class _AdviceListPageState extends State<AdviceListPage> {
  late Future<List<AdviceMeta>> _future;
  AdviceMeta? _latest;
  final Set<String> _unlocked = {};
  final _dateFmt = DateFormat('dd MMM, hh:mm a');

  @override
  void initState() {
    super.initState();
    _load();
    _initUnlocked();
  }

  Future<void> _initUnlocked() async {
    final ids = await AdviceUnlockedStore.getUnlockedIds();
    if (!mounted) return;
    setState(() {
      _unlocked
        ..clear()
        ..addAll(ids);
    });
  }

  void _load() {
    _future = AdviceApi.list(category: widget.category);
    AdviceApi.latest(category: widget.category).then((v) {
      if (!mounted) return;
      setState(() => _latest = v);
      if (v != null && v.id.isNotEmpty) {
        AdviceSeenStore.markSeen(widget.category, v.id);
      }
    });
  }

  Future<void> _unlockLatest() async {
    try {
      final res = await AdviceApi.unlockLatest(widget.category);
      _unlocked.add(res.advice.id);
      await AdviceUnlockedStore.put(res.advice);
      _openAdvice(res.advice);
      setState(() {});
    } on PaymentRequiredException {
      await TopupHelper.ensureFunds(context);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(e.toString())));
    }
  }

  Future<void> _unlockById(String id) async {
    try {
      final res = await AdviceApi.unlockById(id);
      _unlocked.add(res.advice.id);
      await AdviceUnlockedStore.put(res.advice);
      _openAdvice(res.advice);
      setState(() {});
    } on PaymentRequiredException {
      await TopupHelper.ensureFunds(context);
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(e.toString())));
    }
  }

  void _openAdvice(AdviceDetail a) {
    Navigator.of(context).push(
      MaterialPageRoute(builder: (_) => AdviceViewPage(advice: a)),
    );
  }

  @override
  Widget build(BuildContext context) {
    final notifier = Provider.of<ColorNotifire>(context, listen: true);
    final cat = AdviceApi.normalizeCategory(widget.category).toUpperCase();
    return Scaffold(
      backgroundColor: notifier.background,
      appBar: AppBar(
        backgroundColor: notifier.background,
        elevation: 0,
        title: Text(cat, style: TextStyle(color: notifier.textColor)),
        actions: [
          if (_latest != null)
            Padding(
              padding: const EdgeInsets.only(right: 12),
              child: ElevatedButton(
                style: ElevatedButton.styleFrom(
                  backgroundColor: const Color(0xFF8B0000),
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                  minimumSize: const Size(0, 32),
                  tapTargetSize: MaterialTapTargetSize.shrinkWrap,
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                ),
                onPressed: _unlockLatest,
                child: const Text(
                  'Pay latest call',
                  style: TextStyle(color: Colors.white, fontSize: 14, fontWeight: FontWeight.w600),
                ),
              ),
            ),
        ],
      ),
      body: RefreshIndicator(
        onRefresh: () async => setState(_load),
        child: FutureBuilder<List<AdviceMeta>>(
          future: _future,
          builder: (context, snapshot) {
            if (snapshot.connectionState == ConnectionState.waiting) {
              return const Center(child: CircularProgressIndicator());
            }
            if (snapshot.hasError) {
              return Center(child: Text(snapshot.error.toString(), style: TextStyle(color: notifier.textColor)));
            }
            final items = snapshot.data ?? const <AdviceMeta>[];
            if (items.isEmpty) {
              return Center(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(Icons.inbox_outlined, size: 48, color: notifier.divider),
                    const SizedBox(height: 8),
                    Text('No calls yet', style: TextStyle(color: notifier.textColor, fontFamily: 'Manrope-Bold')),
                    const SizedBox(height: 4),
                    const Text('Check back later for new updates', style: TextStyle(color: Color(0xFF94A3B8))),
                  ],
                ),
              );
            }
            return ListView.builder(
              physics: const AlwaysScrollableScrollPhysics(),
              padding: const EdgeInsets.all(12),
              itemCount: items.length,
              itemBuilder: (context, index) {
                final m = items[index];
                final paid = _unlocked.contains(m.id) || (m.price <= 0);
                return Container(
                  margin: const EdgeInsets.only(bottom: 12),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: notifier.textField,
                    borderRadius: BorderRadius.circular(14),
                    border: Border.all(color: notifier.getContainerBorder ?? const Color(0xFFE2E8F0)),
                  ),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.center,
                    children: [
                      Container(
                        height: 36,
                        width: 36,
                        decoration: BoxDecoration(
                          color: notifier.tabBar1,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Icon(
                          paid ? Icons.lock_open : Icons.lock_outline,
                          color: notifier.radioButton,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Call ${index + 1}',
                              style: TextStyle(
                                color: notifier.textColor,
                                fontFamily: 'Manrope-Bold',
                                fontSize: 16,
                              ),
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                            ),
                            const SizedBox(height: 2),
                            Text(
                              _dateFmt.format(m.createdAt),
                              style: const TextStyle(color: Color(0xFF94A3B8), fontSize: 13),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(width: 10),
                      paid
                          ? ElevatedButton(
                              style: ElevatedButton.styleFrom(
                                backgroundColor: const Color(0xFF16A34A),
                                minimumSize: const Size(0, 36),
                                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                              ),
                              onPressed: () async {
                                final cached = await AdviceUnlockedStore.get(m.id);
                                if (cached != null) {
                                  _openAdvice(cached);
                                  return;
                                }
                                try {
                                  final res = await AdviceApi.unlockById(m.id);
                                  await AdviceUnlockedStore.put(res.advice);
                                  _openAdvice(res.advice);
                                } catch (e) {
                                  if (!mounted) return;
                                  ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(e.toString())));
                                }
                              },
                              child: const Text('Open', style: TextStyle(color: Colors.white, fontSize: 14)),
                            )
                          : ElevatedButton(
                              style: ElevatedButton.styleFrom(
                                backgroundColor: const Color(0xFF8B0000),
                                minimumSize: const Size(0, 36),
                                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                              ),
                              onPressed: () => _unlockById(m.id),
                              child: Text('Pay â‚¹${m.price}', style: const TextStyle(color: Colors.white)),
                            ),
                    ],
                  ),
                );
              },
            );
          },
        ),
      ),
    );
  }
}
